# =============================================================================
# Inductive Bible AI - Cloudflare Worker Configuration
# =============================================================================
# Environments:
#   - (default/dev): Local development with `wrangler dev`
#   - staging:       Test deployment with `wrangler deploy --env staging`
#   - production:    Live site with `wrangler deploy --env production`
# =============================================================================

name = "trout"
main = "src/index.ts"
compatibility_date = "2024-12-30"

# =============================================================================
# AI BINDINGS (Workers AI)
# =============================================================================
[ai]
binding = "AI"

# =============================================================================
# DEFAULT/DEV ENVIRONMENT (used with `wrangler dev`)
# =============================================================================
# Serve static assets from the web app build directory
# NOTE: No 'binding' means Cloudflare auto-serves assets (SPA mode)
[assets]
directory = "../web/dist"

[vars]
ENVIRONMENT = "development"
SUPABASE_URL = "https://mwibyylfnfxojdxsbzga.supabase.co"
SUPABASE_ANON_KEY = "sb_publishable_ViDArTpEg-NOc2pzPy360g_nuOb1fZT"
# SUPABASE_SERVICE_ROLE_KEY will be set via .dev.vars for local dev
ENABLE_AUTH = "false"  # Auth disabled for rapid local development

# Dev KV namespace - handled via local simulation in wrangler dev
# [[kv_namespaces]]
# binding = "BIBLE_CACHE"
# id = "dev-bible-cache-preview" 

# D1 Database - Dev (local persistence with wrangler dev --persist)
[[d1_databases]]
binding = "DB"
database_name = "inductive-bible-db"
database_id = "local"  # Placeholder for local dev

# Vectorize - Dev (using staging index for testing)
[[vectorize]]
binding = "VECTORIZE"
index_name = "precept-embeddings-staging"

# =============================================================================
# STAGING ENVIRONMENT (`wrangler deploy --env staging`)
# =============================================================================
[env.staging]
name = "inductive-bible-staging"

[env.staging.assets]
directory = "../web/dist"

[env.staging.vars]
ENVIRONMENT = "staging"
ENABLE_AUTH = "true"
SUPABASE_URL = "https://mwibyylfnfxojdxsbzga.supabase.co"
SUPABASE_ANON_KEY = "sb_publishable_ViDArTpEg-NOc2pzPy360g_nuOb1fZT"

[env.staging.ai]
binding = "AI"

[[env.staging.kv_namespaces]]
binding = "BIBLE_CACHE"
id = "49558b44421f4a858078fd358f176310"

# D1 Database - Staging
# NOTE: Create with: wrangler d1 create inductive-bible-db-staging
[[env.staging.d1_databases]]
binding = "DB"
database_name = "inductive-bible-db-staging"
database_id = "97833613-dd73-4c01-b319-9dbe8f3f0158"

# Vectorize - Staging
# NOTE: Create with: wrangler vectorize create precept-embeddings-staging --dimensions=768 --metric=cosine
[[env.staging.vectorize]]
binding = "VECTORIZE"
index_name = "precept-embeddings-staging"

# =============================================================================
# PRODUCTION ENVIRONMENT (`wrangler deploy --env production`)
# =============================================================================
[env.production]
name = "inductive-bible-prod"
routes = [
  { pattern = "inductivebible.ai", custom_domain = true },
  { pattern = "www.inductivebible.ai", custom_domain = true }
]

[env.production.assets]
directory = "../web/dist"

[env.production.vars]
ENVIRONMENT = "production"
ENABLE_AUTH = "true"
SUPABASE_URL = "https://mwibyylfnfxojdxsbzga.supabase.co"
SUPABASE_ANON_KEY = "sb_publishable_ViDArTpEg-NOc2pzPy360g_nuOb1fZT"

[env.production.ai]
binding = "AI"

[[env.production.kv_namespaces]]
binding = "BIBLE_CACHE"
id = "a90045ce6c8f404a8c7db45b274f0532"

# D1 Database - Production
# NOTE: Create with: wrangler d1 create inductive-bible-db-prod
[[env.production.d1_databases]]
binding = "DB"
database_name = "inductive-bible-db-prod"
database_id = "434f53ed-8cd3-4e90-b6bd-e2eb9b570837"

# Vectorize - Production
# NOTE: Create with: wrangler vectorize create precept-embeddings-prod --dimensions=768 --metric=cosine
[[env.production.vectorize]]
binding = "VECTORIZE"
index_name = "precept-embeddings-prod"
